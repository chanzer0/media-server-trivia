{% extends 'base.html' %}
{% block content %}
<div class="container-fluid game-page">
  <h2 class="text-center mb-4">Cast Reveal</h2>
  <div id="castProgress" class="progress mb-4" style="height: 10px;">
    <div class="progress-bar" role="progressbar" style="width:0%"></div>
  </div>
  <div id="castCircles" class="d-flex justify-content-center flex-wrap gap-3 mb-4"></div>
  <div class="d-flex justify-content-center mb-3">
    <input id="castGuessInput" class="form-control me-2" placeholder="Guess the movie" style="max-width:300px">
    <button id="castGuessBtn" class="btn btn-primary">Guess</button>
  </div>
  <div id="castResult" class="text-center"></div>
</div>
<script>
let castData = null;
let revealed = 1;
const total = 7;

function updateProgress() {
  const percent = ((revealed - 1) / total) * 100;
  document.querySelector('#castProgress .progress-bar').style.width = `${percent}%`;
}

function renderCircles() {
  const container = document.getElementById('castCircles');
  container.innerHTML = '';
  for (let i = 0; i < total; i++) {
    const div = document.createElement('div');
    div.className = 'cast-circle';
    div.textContent = i < revealed && castData.cast[i] ? castData.cast[i] : '?';
    container.appendChild(div);
  }
  updateProgress();
}

async function loadGame() {
  const res = await fetch('/api/trivia/cast');
  castData = await res.json();
  if (!castData.cast) {
    document.getElementById('castResult').innerText = castData.error || 'No data';
    return;
  }
  renderCircles();
}

document.getElementById('castGuessBtn').addEventListener('click', () => {
  const guess = document.getElementById('castGuessInput').value.trim().toLowerCase();
  if (!castData) return;
  if (guess === castData.title.toLowerCase()) {
    document.getElementById('castResult').innerHTML = `<div class='alert alert-success'>Correct! It was ${castData.title}.</div>`;
  } else {
    revealed++;
    if (revealed > total || revealed > castData.cast.length) {
      document.getElementById('castResult').innerHTML = `<div class='alert alert-info'>Out of guesses! It was ${castData.title}.</div>`;
      renderCircles();
      return;
    }
    renderCircles();
  }
});

loadGame();
</script>
{% endblock %}
